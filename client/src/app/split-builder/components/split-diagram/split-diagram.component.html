<div class="diagram-container">
  <!-- Toolbar and FAB above diagram -->
  <div class="diagram-header-bar">
    <div class="diagram-toolbar">
      <button class="icon-button" (click)="zoomToFit()" title="Fit">
        <ion-icon name="expand"></ion-icon>
      </button>
      <button class="icon-button" (click)="resetZoom()" title="Reset">
        <ion-icon name="resize"></ion-icon>
      </button>
      <!-- Header action buttons moved here -->
      <button class="icon-button" (click)="createNewTree.emit()" title="New Split">
        <ion-icon name="add-outline"></ion-icon>
      </button>
      <button class="icon-button" (click)="exportToJSON.emit()" title="Export">
        <ion-icon name="download-outline"></ion-icon>
      </button>
      <button class="icon-button" (click)="exportToSplitXCH.emit()" title="Export SplitXCH">
        <ion-icon name="code-outline"></ion-icon>
      </button>
      <button class="icon-button" (click)="finalizeBlueprint.emit()" title="Finalize Blueprint" *ngIf="showFinalizeButton">
        <ion-icon name="checkmark-done-outline"></ion-icon>
      </button>
    </div>
  </div>
  <div class="diagram-content-wrapper">
    <div #diagramDiv class="diagram-wrapper"></div>
    
    <!-- Sidebar panel with node details -->
    <div class="diagram-sidebar" *ngIf="selectedNode">
      <div class="sidebar-header">
        <h3 class="sidebar-title">{{ selectedNode.name }}</h3>
        <div class="sidebar-basis-points">{{ formatBasisPoints(selectedNode.basisPoints) }}</div>
        <!-- SplitXCH Fee Display -->
        <div class="sidebar-fee-info" *ngIf="selectedNode.isSplitXCH && selectedNode.feeBasisPoints">
          <div class="sidebar-fee-line">
            <span class="sidebar-fee-label">SplitXCH Fee:</span>
            <span class="sidebar-fee-value">{{ formatBasisPoints(selectedNode.feeBasisPoints || 0) }}</span>
          </div>
          <div class="sidebar-net-line" *ngIf="selectedNode.netBasisPoints !== undefined">
            <span class="sidebar-net-label">Net After Fee:</span>
            <span class="sidebar-net-value">{{ formatBasisPoints(selectedNode.netBasisPoints) }}</span>
          </div>
        </div>
      </div>

      <!-- Recipients Section -->
      <div class="sidebar-section" *ngIf="selectedNode.recipients && selectedNode.recipients.length > 0">
        <h4 class="sidebar-section-title">Recipients</h4>
        <div class="sidebar-recipient-list">
          <div class="sidebar-recipient-item" *ngFor="let recipient of selectedNode.recipients">
            <div class="sidebar-recipient-info">
              <div class="sidebar-recipient-name">
                {{ recipient.name }}
                <span class="sidebar-recipient-type">({{ getAddressTypeDisplay(recipient) }})</span>
              </div>
              <div class="sidebar-recipient-address" [class.placeholder]="isPlaceholderAddress(recipient.address)">
                {{ recipient.address }}
              </div>
            </div>
            <div class="sidebar-recipient-actions">
              <span class="sidebar-recipient-percentage">{{ formatBasisPoints(recipient.basisPoints) }}</span>
              <button class="sidebar-icon-button" (click)="onEditRecipient(selectedNode, recipient)" title="Edit">
                <ion-icon name="create-outline"></ion-icon>
              </button>
              <button class="sidebar-icon-button" (click)="onRemoveRecipient(selectedNode, recipient.id)" title="Remove">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Nested Splits Section -->
      <div class="sidebar-section" *ngIf="selectedNode.children && selectedNode.children.length > 0 && isSplitXCHNode(selectedNode)">
        <h4 class="sidebar-section-title">Nested Splits</h4>
        <div class="sidebar-recipient-list">
          <div class="sidebar-recipient-item" *ngFor="let child of selectedNode.children">
            <div class="sidebar-recipient-info">
              <div class="sidebar-recipient-name">{{ child.name }}</div>
              <div class="sidebar-recipient-address">Split Branch</div>
            </div>
            <div class="sidebar-recipient-actions">
              <span class="sidebar-recipient-percentage">{{ formatBasisPoints(child.basisPoints) }}</span>
              <button class="sidebar-icon-button" (click)="onSelectNode(child)" title="Select">
                <ion-icon name="arrow-forward-outline"></ion-icon>
              </button>
              <button class="sidebar-icon-button" (click)="onRemoveNestedSplit(selectedNode, child.id)" title="Remove">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="sidebar-empty" *ngIf="(!selectedNode.recipients || selectedNode.recipients.length === 0) && (!selectedNode.children || selectedNode.children.length === 0)">
        <p>No recipients or nested splits</p>
        <p class="sidebar-empty-hint">Use the + button to add recipients</p>
      </div>
    </div>
  </div>

  <div #deleteBox class="delete-box" [class.drag-over]="isDraggingOverDelete">
    <ion-icon name="trash-outline"></ion-icon>
    <span>Drop Here To Delete</span>
  </div>
  <div class="diagram-hint">
    <ion-icon name="information-circle"></ion-icon>
    <span>Click node name to edit • Right-click for menu • Drag to delete area to remove</span>
  </div>
</div>

